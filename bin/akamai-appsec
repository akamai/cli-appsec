#!/usr/bin/env node

"use strict";

var AppSecConfig = require("../src/appSecConfig").AppSecConfig;
var CRB = require("../src/crb").CRBHandler;

function print(object, options, customPrinter) {
  if (options.json) {
    console.log(JSON.stringify(object));
  } else {
    console.log(customPrinter(options, object));
  }
}

function errorOut(errJson, options, customPrinter=(opt,err)=>{
  return err.detail ? err.detail:err.title;
}) {
  if(options.json) {
    console.error(JSON.stringify(errJson));
  } else {
    console.error(customPrinter(options, errJson));
  }
  process.exit(1);
}

require("sywac")
  .command("structured-rule-template", {
    desc: "Prints sample JSON of a structured custom rule.",
    aliases: ["srt"],
    run: options => {
      console.log(new CRB().template());
    }
  })
  .command("configs", {
    desc: "List configurations",
    setup: sywac => {
      sywac.boolean("--json", {
        desc: "Print the raw json response",
        group: "Options:"
      });
    },
    run: options => {
      new AppSecConfig().configs(options).then(res => {
        print(res, options, (options, object)=>{
          let str = [];
          for(let i=0;object&&i<object.length;i++) {
            str.push(object[i].configId);
          }
          return str.join('\n');
        });
      }).catch(err => {
        errorOut(err, options);
      });
    }
  })
  .command("custom-rule", {
    desc: "Display contents of custom rule",
    setup: sywac => {
      sywac.number("--config <id>", {
          desc: "Configuration id. Mandatory if you have more than one configuration.",
          group: "Options:",
          required: false
        })
        .number("--ruleid <id>", {
          desc: "Rule ID.",
          group: "Options:",
          required: true
        });
    },
    run: options => {
      new CRB().getRule(options.config, options.ruleid).then(data => {
        console.log(data);
      }).catch(err => {
        errorOut(err, options);
      });
    }
  })
  .command("custom-rules", {
    desc: "List all custom rules",
    setup: sywac => {
      sywac.number("--config <id>", {
        desc: "Configuration id. Mandatory if you have more than one configuration.",
        group: "Options:",
        required: false
      });
    },
    run: options => {
      new CRB().getAllRules(options).then(data => {
        console.log(data);
      }).catch(err => {
        errorOut(err, options);
      });
    }
  })
  .command("custom-rule", {
        desc: "Display contents of custom rule",
        setup: sywac => {
          sywac.number("--config <id>", {
            desc: "Configuration id. Mandatory if you have more than one configuration.",
            group: "Options:",
            required: false
          })
          .number("--ruleId <id>", {
              desc: "Rule ID.",
              group: "Options:",
              required: true
          });
        },
        run: options => {
          new CRB().getRule(options).then(data => {
              //FIXME:  Remove text once this starts actually connecting to a live service.
            console.log('data' + data);
          }).catch(err=>{
              //FIXME:  Remove text once this starts actually connecting to a live service.
              errorOut(err, options);
          });
        }
      })
    .command("create-custom-rule", {
        desc: "Create custom rule",
        setup: sywac => {
            sywac.number("--config <id>", {
                desc: "Configuration id. Mandatory if you have more than one configuration.",
                group: "Options:",
                required: false
            })

            .file('--file <path>', {
                desc: 'File with JSON rules',
                group: "Options:",
                required: true,
                mustExist: true
            });
        },
        run: options => {
            new CRB().createRule(options).then(data => {
                //FIXME:  Remove text once this starts actually connecting to a live service.
                console.log('data: ' + data);
            }).catch(err=>{
                //FIXME:  Remove text once this starts actually connecting to a live service.
                errorOut(err, options);
            });
        }
    })
    .command("modify-custom-rule", {
        desc: "Update existing custom rule",
        setup: sywac => {
            sywac.number("--config <id>", {
                desc: "Configuration id. Mandatory if you have more than one configuration.",
                group: "Options:",
                required: false
            })
            .number("--ruleId <id>", {
                desc: "Rule ID.",
                group: "Options:",
                required: true
            })
            .file('--file <path>', {
                desc: 'File with JSON rules',
                mustExist: true
            });
        },
        run: options => {
            new CRB().createRule(options).then(data => {
                //FIXME:  Remove text once this starts actually connecting to a live service.
                console.log('data: ' + data);
            }).catch(err=>{
                //FIXME:  Remove text once this starts actually connecting to a live service.
                errorOut(err, options);
            });
        }
    })

  .command("config-versions", {
    desc: "List all versions",
    setup: sywac => {
      sywac.number("--config <id>", {
        desc: "Configuration id. Mandatory if you have more than one configuration.",
        group: "Options:",
        required: false
      });
    },
    run: options => {
      new AppSecConfig().versions(options).then(data => {
        print(data, options, (options, versions) => {
          let vids = [];
          for (let i = 0; i < versions.versionList.length; i++) {
            vids.push(versions.versionList[i].version);
          }
          return vids.join("\n");
        });
      }).catch(err => {
        errorOut(err, options);
      });
    }
  })
  .command("config-version", {
    desc: "Read a config version",
    setup: sywac => {
      sywac.number("--config <id>", {
        desc: "Configuration id number",
        group: "Options:",
        required: false
      }).string("--version-id <id>", {
        desc: "The version id number. It can also take the values 'PROD' or 'PRODUCTION' or 'STAGING'. If not provided, latest version is assumed.",
        group: "Options:",
        required: false
      });
    },
    run: options => {
      new AppSecConfig().version(options).then(versionObject => {
        print(versionObject, options, (options, data)=>{
          return data.version;
        });
      }).catch(err => {
        errorOut(err, options);
      });
    }
  })
  .showHelpByDefault()
  .help("--help", {
    group: "Command options:",
    desc: "Prints help information."
  })
  .version("--version", {
    group: "Command options:",
    desc: "Current version of the program."
  })
  .epilogue("Copyright (C) Akamai Technologies, Inc\nVisit http://github.com/akamai/cli-appsec for detailed documentation\n")
  .outputSettings({
    maxWidth: 75
  })
  .parse()
  .then(result => {
    if (result.errors.length) {
      console.error("ERROR: ", result.errors[0] || JSON.stringify(result.errors[0]));
      console.output = "";
    }
    // if help requested, log it and exit
    if (result.output) {
      console.log(result.output);
      process.exit(result.code);
    }
  });
