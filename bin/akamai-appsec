#!/usr/bin/env node

"use strict";

var Config = require("../src/configprovider").configProvider;
var CRB = require("../src/crb").CRBHandler;
var SelectedHosts = require("../src/hosts").selectedHosts;
var fs = require('fs');
let Version = require('../src/versionsprovider').versionProvider;
let MatchTarget = require('../src/matchtarget').matchTarget;
let Policy = require('../src/policy').policy;

function print(object, options, customPrinter) {
  if (options.json) {
    console.log(JSON.stringify(object));
  } else {
    console.log(customPrinter(options, object));
  }
}

function errorOut(errJson, options, customPrinter=(opt,err)=>{
  return typeof err=='string'? err: (err.detail ? err.detail : err.title);
}) {
  if(options.json) {
    console.error(JSON.stringify(errJson));
  } else {
    console.error(customPrinter(options, errJson));
  }
  process.exit(1);
}

function handle(handlerOptions) {
  handlerOptions.promise.then(res=>{
    print(res, handlerOptions.args, handlerOptions.success);
  }).catch(err=>{
    errorOut(err, handlerOptions.args, handlerOptions.error);
  });
}

require("sywac")
  .command("structured-rule-template", {
    desc: "Prints sample JSON of a structured custom rule.",
    aliases: ["srt"],
    run: options => {
      console.log(new CRB(options).template());
    }
  })
  .command("configs", {
    desc: "List configurations",
    run: options => {
      handle({
        promise: new Config(options).configs(),
        args:options,
        success:(args, data)=>{
          let str = [];
          for(let i=0;data&&i<data.length;i++) {
            str.push(data[i].configId);
          }
          return str.join('\n');
        }
      });
    }
  })
  .command("custom-rules", {
    desc: "List all custom rules",
    setup: sywac => {
      sywac.number("--config <id>", {
        desc: "Configuration id. Mandatory if you have more than one configuration.",
        group: "Options:",
        required: false
      });
    },
    run: options => {
      handle({
        promise: new CRB(options).getAllRules(),
        args:options,
        success:(args, data)=>{
          let str = [];
          for(let i=0;data&&i<data.length;i++) {
            str.push(data[i].ruleId);
          }
          return str.join('\n');
        }
      });
    }
  })
  .command("custom-rule", {
        desc: "Display contents of custom rule",
        setup: sywac => {
          sywac.number("--config <id>", {
            desc: "Configuration id. Mandatory if you have more than one configuration.",
            group: "Options:",
            required: false
          })
          .number("--custom-rule <id>", {
              desc: "Rule ID.",
              group: "Options:",
              required: true
          });
        },
        run: options => {
          handle({
            promise: new CRB(options).getRule(),
            args:options,
            success:(args, data)=>{
              return data;
            }
          });
        }
      })
    .command("create-custom-rule", {
        desc: "Create custom rule",
        setup: sywac => {
            sywac.number("--config <id>", {
                desc: "Configuration id. Mandatory if you have more than one configuration.",
                group: "Options:",
                required: false
            })

            .file('--file <path>', {
                desc: 'File with JSON rules',
                group: "Options:",
                required: true,
                mustExist: true
            });
        },
        run: options => {
          handle({
            promise: new CRB(options).createRule(),
            args:options,
            success:(args, data)=>{
              return data;
            }
          });
        }
    })
    .command("modify-custom-rule", {
        desc: "Update existing custom rule",
        setup: sywac => {
            sywac.number("--config <id>", {
                desc: "Configuration id. Mandatory if you have more than one configuration.",
                group: "Options:",
                required: false
            })
            .number("--ruleId <id>", {
                desc: "Rule ID.",
                group: "Options:",
                required: true
            })
            .file('--file <path>', {
                desc: 'File with JSON rules',
                mustExist: true
            });
        },
        run: options => {
          handle({
            promise: new CRB(options).updateRule(),
            args:options,
            success:(args, data)=>{
              return data;
            }
          });
        }
    })

  .command("versions", {
    desc: "List all config versions",
    setup: sywac => {
      sywac.number("--config <id>", {
        desc: "Configuration id. Mandatory if you have more than one configuration.",
        group: "Options:",
        required: false
      });
    },
    run: options => {
      handle({
        promise: new Version(options).versions(),
        args:options,
        success:(args, data)=>{
          let vids = [];
          for (let i = 0; i < data.versionList.length; i++) {
            vids.push(data.versionList[i].version);
          }
          return vids.join("\n");
        }
      });
    }
  })
  .command("version", {
    desc: "Read a config version",
    setup: sywac => {
      sywac.number("--config <id>", {
        desc: "Configuration id number",
        group: "Options:",
        required: false
      }).string("--version <num>", {
        desc: "The version number. It can also take the values 'PROD' or 'PRODUCTION' or 'STAGING'. If not provided, latest version is assumed.",
        group: "Options:",
        required: false
      });
    },
    run: options => {
      handle({
        promise: new Version(options).version(),
        args:options,
        success:(args, data)=>{
          //we want the whole json irrespective of the json flag
          return data;
        }
      });
    }
  })
  .command("add-hostname", {
    desc: "Add hostnames to selected list",
    setup: sywac => {
        sywac.number("--config <id>", {
            desc: "Configuration id. Mandatory if you have more than one configuration.",
            group: "Options:",
            required: false
        }).string("--version <num>", {
          desc: "The version number. It can also take the values 'PROD' or 'PRODUCTION' or 'STAGING'. If not provided, latest version is assumed.",
          group: "Options:",
          required: false
       }).stringArray('--hosts <a.com, b.net, c.d.com>',{
          desc: "Hostnames to add to the selected list.",
          group: "Options:",
          required: true
      });
    },
    run: options => {
      handle({
        promise: new SelectedHosts(options).addHosts(),
        args:options,
        success:(args, data)=>{
          let hosts = [];
            for (let i = 0; i < data.hostnameList.length; i++) {
              hosts.push(data.hostnameList[i].hostName);
            }
            return hosts.join("\n");
        }
      });
    }
}).command("selectable-hostnames", {
  desc: "List all selectable host names",
  setup: sywac => {
      sywac.number("--config <id>", {
          desc: "Configuration id. Mandatory if you have more than one configuration.",
          group: "Options:",
          required: false
      }).string("--version <id>", {
        desc: "The version number. It can also take the values 'PROD' or 'PRODUCTION' or 'STAGING'. If not provided, latest version is assumed.",
        group: "Options:",
        required: false
     });
  },
  run: options => {
    handle({
      promise: new SelectedHosts(options).selectableHosts(),
      args:options,
      success:(args, data)=>{
        let hosts = [];
        for (let i = 0; i < data.availableSet.length; i++) {
          hosts.push(data.availableSet[i].hostName);
        }
        return hosts.join("\n");
      }
    });
  }
}).command("create-match-target", {
  desc: "Creates a match target",
  setup: sywac => {
      sywac.number("--config <id>", {
          desc: "Configuration id. Mandatory if you have more than one configuration.",
          group: "Options:",
          required: false
      }).string("--version <id>", {
        desc: "The version number. It can also take the values 'PROD' or 'PRODUCTION' or 'STAGING'. If not provided, latest version is assumed.",
        group: "Options:",
        required: false
      }).stringArray("--hostnames <a.com, b.net, c.d.com>", {
        desc: "Hostnames to add.",
        group: "Options:",
        required: true
      }).stringArray("--paths <x,y,z>", {
        desc: "The file paths",
        group: "Options:",
        required: true
      }).string("--policy <id>", {
        desc: "The policy id.",
        group: "Options:",
        required: true
      });
  },
  run: options => {
    handle({
      promise: new MatchTarget(options).createMatchTarget(),
      args:options,
      success:(args, data)=>{
        return data;
      }
    });
  }
}).command("policies", {
  desc: "List all policies",
  setup: sywac => {
      sywac.number("--config <id>", {
          desc: "Configuration id. Mandatory if you have more than one configuration.",
          group: "Options:",
          required: false
      }).string("--version <id>", {
        desc: "The version number. It can also take the values 'PROD' or 'PRODUCTION' or 'STAGING'. If not provided, latest version is assumed.",
        group: "Options:",
        required: false
     });
  },
  run: options => {
    handle({
      promise: new Policy(options).policies(),
      args:options,
      success:(args, data)=>{
        let s = [];
        for (let i = 0; i < data.policies.length; i++) {
          s.push(data.policies[i].policyId);
        }
        return s.join("\n");
      }
    });
  }
})
  .boolean("--json", {
    desc: "Print the raw json response. All commands respect this option.",
    group: "Command options:",
    required: false
  })
  .string("--edgerc", {
    desc: "The full path to the .edgerc file.",
    group: "Command options:",
    required: false
  })
  .string("--section", {
    desc: "The section of .edgerc to use.",
    group: "Command options:",
    required: false
  })
  .showHelpByDefault()
  .help("--help", {
    group: "Command options:",
    desc: "Prints help information."
  })
  .boolean("--version", {
    group: "Command options:",
    desc: "Current version of the program."
  })
  .epilogue("Copyright (C) Akamai Technologies, Inc\nVisit http://github.com/akamai/cli-appsec for detailed documentation\n")
  .outputSettings({
    maxWidth: 100
  })
  .parse()
  .then(result => {
    if (result.errors.length) {
      console.error("ERROR: ", result.errors[0] || JSON.stringify(result.errors[0]));
      console.output = "";
    }
    // if help requested, log it and exit
    
    //console.log("---"+JSON.stringify(result));
    if(result.argv.version && result.details.args.length == 1) {
      //print version info
      let s = fs.readFileSync(__dirname+'/../package.json', 'utf8');
      console.log(JSON.parse(s).version);
      process.exit(0);
    }
    else if (result.output) {
      console.log(result.output);
      process.exit(result.code);
    }
  });
